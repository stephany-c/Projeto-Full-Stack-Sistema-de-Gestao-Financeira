<div class="transaction-list-container">
    <div class="header-actions">
        <h2>Transações</h2>
    </div>

    <div class="filters">
        <div class="filter-header">
            <mat-icon>filter_list</mat-icon>
            <span>FILTROS</span>
        </div>
        <mat-form-field appearance="outline" class="range-field">
            <mat-label>Período</mat-label>
            <mat-date-range-input [rangePicker]="rangePicker">
                <input matStartDate [ngModel]="startDate()" (ngModelChange)="startDate.set($event); applyFilter()"
                    placeholder="Início">
                <input matEndDate [ngModel]="endDate()" (ngModelChange)="endDate.set($event); applyFilter()"
                    placeholder="Fim">
            </mat-date-range-input>
            <mat-datepicker-toggle matIconSuffix [for]="rangePicker"></mat-datepicker-toggle>
            <mat-date-range-picker #rangePicker></mat-date-range-picker>
        </mat-form-field>

        <mat-form-field appearance="outline">
            <mat-label>Categoria</mat-label>
            <mat-select [ngModel]="selectedCategoryId()"
                (ngModelChange)="selectedCategoryId.set($event); applyFilter()">
                <mat-option value="">Todas</mat-option>
                <mat-option *ngFor="let cat of categories()" [value]="cat.id">{{ cat.name }}</mat-option>
            </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
            <mat-label>Tipo</mat-label>
            <mat-select [ngModel]="selectedType()" (ngModelChange)="selectedType.set($event); applyFilter()">
                <mat-option value="">Todos</mat-option>
                <mat-option value="INCOME">Receitas</mat-option>
                <mat-option value="EXPENSE">Despesas</mat-option>
            </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="search-field">
            <mat-label>Buscar</mat-label>
            <mat-icon matPrefix>search</mat-icon>
            <input matInput [ngModel]="searchTerm()" (ngModelChange)="searchTerm.set($event); applyFilter()"
                placeholder="Descrição...">
        </mat-form-field>

        <button mat-stroked-button (click)="clearFilter()">
            <mat-icon>clear</mat-icon> Limpar Filtros
        </button>
    </div>

    <table class="transaction-table">
        <thead>
            <tr>
                <th>Data</th>
                <th>Descrição</th>
                <th>Categoria</th>
                <th>Tipo</th>
                <th>Valor</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            <ng-container *ngFor="let t of transactions()">
                <!-- View Mode -->
                <tr *ngIf="editingTransactionId() !== t.id" [ngClass]="t.type.toLowerCase()">
                    <td data-label="Data">{{ t.date | date:'dd/MM/yyyy' }}</td>
                    <td data-label="Descrição">{{ t.description }}</td>
                    <td data-label="Categoria">
                        <span class="category-badge">{{ t.categoryName }}</span>
                    </td>
                    <td data-label="Tipo">{{ t.type === 'INCOME' ? 'Receita' : 'Despesa' }}</td>
                    <td data-label="Valor">{{ t.amount | currency:'BRL' }}</td>
                    <td data-label="Ações">
                        <div class="actions">
                            <button mat-icon-button (click)="startEdit(t)" title="Editar" color="primary">
                                <mat-icon>edit</mat-icon>
                            </button>
                            <button mat-icon-button (click)="deleteTransaction(t.id)" title="Excluir" color="warn">
                                <mat-icon>delete</mat-icon>
                            </button>
                        </div>
                    </td>
                </tr>

                <!-- Edit Mode -->
                <tr *ngIf="editingTransactionId() === t.id" class="edit-row">
                    <td data-label="Data">
                        <mat-form-field appearance="outline" class="edit-date-field">
                            <input matInput [matDatepicker]="editPicker" [(ngModel)]="editData.date">
                            <mat-datepicker-toggle matIconSuffix [for]="editPicker"></mat-datepicker-toggle>
                            <mat-datepicker #editPicker></mat-datepicker>
                        </mat-form-field>
                    </td>
                    <td data-label="Descrição">
                        <input type="text" [(ngModel)]="editData.description" class="edit-input">
                    </td>
                    <td data-label="Categoria">
                        <select [(ngModel)]="editData.categoryId" class="edit-input">
                            <option *ngFor="let cat of categories()" [value]="cat.id">{{ cat.name }}</option>
                        </select>
                    </td>
                    <td data-label="Tipo">
                        <select [(ngModel)]="editData.type" class="edit-input">
                            <option value="INCOME">Receita</option>
                            <option value="EXPENSE">Despesa</option>
                        </select>
                    </td>
                    <td data-label="Valor">
                        <input type="number" [(ngModel)]="editData.amount" step="0.01" class="edit-input">
                    </td>
                    <td data-label="Ações">
                        <div class="actions">
                            <button mat-icon-button (click)="saveEdit()" title="Salvar" color="primary">
                                <mat-icon>check</mat-icon>
                            </button>
                            <button mat-icon-button (click)="cancelEdit()" title="Cancelar">
                                <mat-icon>close</mat-icon>
                            </button>
                        </div>
                    </td>
                </tr>
            </ng-container>
        </tbody>
    </table>

    <p *ngIf="transactions().length === 0" class="empty-msg">Nenhuma transação encontrada.</p>

    <mat-paginator *ngIf="transactions().length > 0" [length]="totalElements()" [pageSize]="pageSize()"
        [pageIndex]="currentPage()" [pageSizeOptions]="[5, 10, 20, 50]" (page)="onMatPageChange($event)"
        showFirstLastButtons>
    </mat-paginator>
</div>