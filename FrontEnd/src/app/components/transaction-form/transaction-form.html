<div class="form-container">
    <h2>{{ isEditing() ? 'Editar Transação' : 'Nova Transação' }}</h2>

    <form [formGroup]="transactionForm" (ngSubmit)="onSubmit()">
        <mat-form-field appearance="outline" class="full-width">
            <mat-label>Descrição</mat-label>
            <input matInput formControlName="description" placeholder="Ex: Salário, Aluguel...">
            <mat-error *ngIf="transactionForm.get('description')?.hasError('required')">
                A descrição é obrigatória.
            </mat-error>
            <mat-error *ngIf="transactionForm.get('description')?.hasError('minlength')">
                Mínimo de 3 caracteres.
            </mat-error>
        </mat-form-field>

        <div class="form-row">
            <mat-form-field appearance="outline">
                <mat-label>Valor (R$)</mat-label>
                <input matInput [value]="formattedAmount()" (input)="onAmountInput($event)" (blur)="onAmountBlur()"
                    placeholder="R$ 0,00">
                <mat-error *ngIf="transactionForm.get('amount')?.hasError('required')">
                    O valor é obrigatório.
                </mat-error>
                <mat-error *ngIf="transactionForm.get('amount')?.hasError('min')">
                    O valor deve ser maior que 0.
                </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
                <mat-label>Data</mat-label>
                <input matInput [matDatepicker]="picker" formControlName="date">
                <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                <mat-datepicker #picker></mat-datepicker>
                <mat-error *ngIf="transactionForm.get('date')?.invalid">
                    A data é obrigatória.
                </mat-error>
            </mat-form-field>
        </div>

        <div class="form-row">
            <mat-form-field appearance="outline">
                <mat-label>Tipo</mat-label>
                <mat-select formControlName="type">
                    <mat-option value="INCOME">Receita</mat-option>
                    <mat-option value="EXPENSE">Despesa</mat-option>
                </mat-select>
            </mat-form-field>

            <div class="category-field">
                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Categoria</mat-label>
                    <mat-select formControlName="categoryId">
                        <mat-option *ngFor="let cat of categories()" [value]="cat.id">
                            {{ cat.name }}
                        </mat-option>
                    </mat-select>
                    <mat-hint *ngIf="loading()">Carregando categorias...</mat-hint>
                    <mat-error *ngIf="!hasCategories() && !loading()">
                        Nenhuma categoria encontrada.
                    </mat-error>
                </mat-form-field>
                <button mat-icon-button type="button" (click)="toggleQuickAdd()"
                    [title]="isAddingCategory() ? 'Cancelar' : 'Nova Categoria'" class="btn-add-cat">
                    <mat-icon>{{ isAddingCategory() ? 'close' : 'add' }}</mat-icon>
                </button>
            </div>
        </div>

        <div *ngIf="!loading() && !hasCategories() && !isAddingCategory()" class="no-cat-warning">
            <mat-icon color="warn">warning</mat-icon>
            Você ainda não tem categorias.
            <a (click)="toggleQuickAdd()" class="link">Criar Agora</a>
        </div>

        <div *ngIf="isAddingCategory()" class="quick-add">
            <mat-form-field appearance="outline" class="full-width">
                <mat-label>Nova categoria</mat-label>
                <input matInput [(ngModel)]="newCategoryName" [ngModelOptions]="{standalone: true}"
                    placeholder="Nome da categoria..." (keyup.enter)="quickAddCategory()">
            </mat-form-field>
            <button mat-flat-button color="primary" type="button" (click)="quickAddCategory()"
                [disabled]="!newCategoryName.trim()">Salvar</button>
        </div>

        <button mat-flat-button color="primary" type="submit" [disabled]="transactionForm.invalid" class="btn-submit">
            <mat-icon>save</mat-icon>
            Salvar Transação
        </button>
    </form>
</div>